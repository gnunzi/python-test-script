name: Deploy to azimut

on:
  push:
    branches: [ main ]

  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

jobs:
  # This workflow contains a single job called "build"
  send_operation_to_azimut:
    runs-on: ubuntu-latest

    steps:
      - name: Get current time
        uses: 1466587594/get-current-time@v2
        id: current-time
        
      - name: Authentication to azimut
        uses: GiorgioNunzi/http-request-action@master
        id: az-authentication
        with:
          url: 'https://cloud.azeti.net/acp-service/authentication/auth'
          method: post
          #data: '{"u": "e" }'
          data: '{ "username": "${{ secrets.AZ_USERNAME }}", "password": "${{ secrets.AZ_PASSWORD }}" }'
          #contentType: application/x-www-form-urlencoded
          #data: username=${{ secrets.AZ_USERNAME }}&password=${{ secrets.AZ_PASSWORD }}
          
      - name: Show response
        run: echo ${{ fromJson(steps.az-authentication.outputs.response["token"]) }}

      - name: Send operation
        uses: GiorgioNunzi/http-request-action@master
        env:
          TOKEN: ${{ steps.az-authentication.outputs.response["token"] }}
        with:
          url: 'https://cloud.azeti.net/acp-service/import/giorgio_sc/hd'
          method: post
          customHeaders: '{"X-Authorization": "${{ env.TOKEN }}" }'
          data: '{ "sensor_id": "~ Orchestrator: Operation", "value": "pull script python-test-script.it", "time": "${{ steps.current-time.outputs.time }}" }'
